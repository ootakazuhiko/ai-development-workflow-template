name: "AIæ–‡è„ˆç¶™æ‰¿è‡ªå‹•åŒ–"

on:
  issues:
    types: [closed, labeled]
  pull_request:
    types: [closed]

jobs:
  auto-context-inheritance:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install
        
      - name: Extract Phase from Labels
        id: phase-detection
        run: |
          LABELS="${{ github.event.issue.labels || github.event.pull_request.labels }}"
          echo "Analyzing labels: $LABELS"
          
          # ãƒ•ã‚§ãƒ¼ã‚ºãƒ©ãƒ™ãƒ«ã‚’æ¤œå‡º
          if echo "$LABELS" | grep -q "phase:requirements"; then
            echo "phase=requirements" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "phase:poc"; then
            echo "phase=poc" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "phase:implementation"; then
            echo "phase=implementation" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "phase:review"; then
            echo "phase=review" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "phase:testing"; then
            echo "phase=testing" >> $GITHUB_OUTPUT
          else
            echo "phase=unknown" >> $GITHUB_OUTPUT
          fi
          
      - name: Auto-extract Context Information
        id: context-extraction
        if: steps.phase-detection.outputs.phase != 'unknown'
        run: |
          node scripts/auto-context-extractor.js \
            --phase="${{ steps.phase-detection.outputs.phase }}" \
            --issue-number="${{ github.event.issue.number || github.event.pull_request.number }}" \
            --issue-title="${{ github.event.issue.title || github.event.pull_request.title }}" \
            --issue-body="${{ github.event.issue.body || github.event.pull_request.body }}" \
            --repository="${{ github.repository }}"
            
      - name: Generate Next Phase Context
        if: steps.context-extraction.outputs.success == 'true'
        run: |
          node scripts/generate-next-phase-context.js \
            --current-phase="${{ steps.phase-detection.outputs.phase }}" \
            --repository="${{ github.repository }}"
            
      - name: Create Next Phase Issue
        if: steps.context-extraction.outputs.next-phase-needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const nextPhaseContext = fs.readFileSync('temp/next-phase-context.md', 'utf8');
            const nextPhase = '${{ steps.context-extraction.outputs.next-phase }}';
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ ${nextPhase}ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ - AIæ–‡è„ˆç¶™æ‰¿`,
              body: nextPhaseContext,
              labels: [`phase:${nextPhase}`, 'auto-generated', 'context-inheritance']
            });
            
            console.log(`Created next phase issue: ${issue.data.html_url}`);
              - name: Evaluate Context Quality
        if: steps.context-extraction.outputs.success == 'true'
        id: quality-evaluation
        run: |
          node scripts/ai-context-quality-evaluator.js \
            --phase="${{ steps.phase-detection.outputs.phase }}" \
            --context-file="docs/ai-context/ai-context-${{ steps.phase-detection.outputs.phase }}.yml"
            
      - name: Send Team Notifications
        if: steps.context-extraction.outputs.success == 'true'
        run: |
          # Slacké€šçŸ¥ï¼ˆWebhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
          if [ ! -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            node scripts/team-notifications.js \
              --webhook-url="${{ secrets.SLACK_WEBHOOK_URL }}" \
              --phase="${{ steps.phase-detection.outputs.phase }}" \
              --issue-url="${{ github.event.issue.html_url || github.event.pull_request.html_url }}" \
              --repository="${{ github.repository }}" \
              --quality-score="${{ steps.quality-evaluation.outputs.quality-score }}"
          fi
          
          # Teamsé€šçŸ¥ï¼ˆWebhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
          if [ ! -z "${{ secrets.TEAMS_WEBHOOK_URL }}" ]; then
            node scripts/team-notifications.js \
              --teams-webhook="${{ secrets.TEAMS_WEBHOOK_URL }}" \
              --phase="${{ steps.phase-detection.outputs.phase }}" \
              --issue-url="${{ github.event.issue.html_url || github.event.pull_request.html_url }}" \
              --repository="${{ github.repository }}" \
              --quality-score="${{ steps.quality-evaluation.outputs.quality-score }}"
          fi
          
      - name: Add Quality Comment
        if: steps.context-extraction.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const qualityScore = '${{ steps.quality-evaluation.outputs.quality-score }}';
            const qualityGrade = '${{ steps.quality-evaluation.outputs.quality-grade }}';
            const needsImprovement = '${{ steps.quality-evaluation.outputs.needs-improvement }}' === 'true';
            
            const qualityEmoji = qualityScore >= 90 ? 'ğŸ†' : 
                                 qualityScore >= 80 ? 'â­' : 
                                 qualityScore >= 70 ? 'âœ…' : 
                                 qualityScore >= 60 ? 'âš ï¸' : 'ğŸ”´';
            
            let comment = `## ğŸ¤– AIæ–‡è„ˆç¶™æ‰¿å®Œäº†
            
**ãƒ•ã‚§ãƒ¼ã‚º**: ${{ steps.phase-detection.outputs.phase }}
**å“è³ªã‚¹ã‚³ã‚¢**: ${qualityEmoji} ${qualityScore}/100 (ã‚°ãƒ¬ãƒ¼ãƒ‰: ${qualityGrade})
**æ¬¡ãƒ•ã‚§ãƒ¼ã‚º**: ${{ steps.context-extraction.outputs.next-phase }}

### ğŸ“Š æ–‡è„ˆç¶™æ‰¿çµæœ
- âœ… æ–‡è„ˆãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†
- âœ… æ§‹é€ åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
- âœ… å“è³ªè©•ä¾¡å®Ÿè¡Œ
${needsImprovement ? '- âš ï¸ å“è³ªæ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™' : '- âœ… å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™'}

### ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
- \`docs/ai-context/ai-context-${{ steps.phase-detection.outputs.phase }}.yml\`
- \`docs/ai-context/quality-reports/quality-${{ steps.phase-detection.outputs.phase }}-*.yml\``;

            if ('${{ steps.context-extraction.outputs.next-phase-needed }}' === 'true') {
              comment += `
- ğŸ†• æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºIssueè‡ªå‹•ä½œæˆæ¸ˆã¿`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
      - name: Commit Context Files
        if: steps.context-extraction.outputs.success == 'true'
        run: |
          git config --global user.name 'AI Context Bridge Bot'
          git config --global user.email 'ai-context-bridge@github.com'
          git add docs/ai-context/
          git add temp/next-phase-context.md || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-generated AI context inheritance for ${{ steps.phase-detection.outputs.phase }} phase (Quality: ${{ steps.quality-evaluation.outputs.quality-grade }})"
            git push
          fi
