name: "AI Development Workflow"
on:
  issues:
    types: [opened, edited, labeled]
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
jobs:
  phase-detection:
    runs-on: ubuntu-latest
    steps:
      - name: フェーズ自動検出
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue ? context.payload.issue.labels.map(l => l.name) : [];
            let phase = 'other';
            if (labels.includes('requirements')) phase = 'requirements';
            else if (labels.includes('poc')) phase = 'poc';
            else if (labels.includes('implementation')) phase = 'implementation';
            else if (labels.includes('review')) phase = 'review';
            core.setOutput('phase', phase);
  requirements-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'requirements'
    runs-on: ubuntu-latest
    steps:
      - name: 要件定義フェーズガイダンス
        run: |
          echo "要件定義フェーズです。AI議論・参照ドキュメント・人間レビューを進めてください。"
          echo "推奨プロンプト: 要件を明確にし、AIと議論してください。"
  poc-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'poc'
    runs-on: ubuntu-latest
    steps:
      - name: PoCフェーズガイダンス
        run: |
          echo "PoCフェーズです。Windsurf向けプロンプトを活用し、重要ポイントを意識してください。"
  pr-automation:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Copilot Agent自動追加
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: ['github-copilot']
            });
      - name: AIレビュー基準説明
        run: |
          echo "AIレビュー観点: 標準準拠、セキュリティ、パフォーマンス、カバレッジ"
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: セキュリティスキャン
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
  human-review-reminder:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'human-review-required')
    steps:
      - name: 人間レビューリマインダー
        run: |
          echo "human-review-requiredラベルが付与されています。チェックリストを確認してください。"
