name: "AI Development Workflow"
on:
  issues:
    types: [opened, edited, labeled]
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
jobs:
  phase-detection:
    runs-on: ubuntu-latest
    outputs:
      phase: ${{ steps.detect_phase.outputs.phase }}
    steps:
      - name: ãƒ•ã‚§ãƒ¼ã‚ºè‡ªå‹•æ¤œå‡º
        id: detect_phase
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue ? context.payload.issue.labels.map(l => l.name) : [];
            let phase = 'other';
            if (labels.includes('requirements')) phase = 'requirements';
            else if (labels.includes('poc')) phase = 'poc';
            else if (labels.includes('implementation')) phase = 'implementation';
            else if (labels.includes('review')) phase = 'review';
            else if (labels.includes('testing')) phase = 'testing'; // testing ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            core.setOutput('phase', phase);
  requirements-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'requirements'
    runs-on: ubuntu-latest
    steps:
      - name: è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚ºã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¯ è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚º

AIã¨ã®è­°è«–ã€å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç¢ºèªã€äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚

**è©³ç´°ã‚¬ã‚¤ãƒ‰:**
- [è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚ºã®é€²ã‚æ–¹](../../docs/WORKFLOW_GUIDE.md#phase-1-è¦ä»¶å®šç¾©)

**é–¢é€£ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹:**
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸè¨­å®š (æœªå®Ÿæ–½ã®å ´åˆ): \`npm run setup\`
- ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®æ–‡è„ˆè¨˜éŒ²: \`npm run ai-context -- complete --phase=requirements\`

**æ¨å¥¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹:**
- ã€Œã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èƒŒæ™¯ã¨ç›®çš„ã‚’è€ƒæ…®ã—ã€ä¸»è¦ãªæ©Ÿèƒ½è¦ä»¶ã‚’3ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚ã€
- ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼Xã«ã¤ã„ã¦ã€è€ƒãˆã‚‰ã‚Œã‚‹æŠ€è¡“çš„èª²é¡Œã¨è§£æ±ºç­–ã‚’æŒ™ã’ã¦ãã ã•ã„ã€‚ã€`
            });
  poc-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'poc'
    runs-on: ubuntu-latest
    steps:
      - name: PoCãƒ•ã‚§ãƒ¼ã‚ºã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ§ª PoCãƒ•ã‚§ãƒ¼ã‚º

Windsurfå‘ã‘ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãªã©ã‚’æ´»ç”¨ã—ã€æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã®æ¤œè¨¼ã‚„é‡è¦ãƒã‚¤ãƒ³ãƒˆã®æ´—ã„å‡ºã—ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

**è©³ç´°ã‚¬ã‚¤ãƒ‰:**
- [PoCãƒ•ã‚§ãƒ¼ã‚ºã®é€²ã‚æ–¹](../../docs/WORKFLOW_GUIDE.md#phase-2-pocé–‹ç™º)

**é–¢é€£ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹:**
- PoCãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®æ–‡è„ˆç¶™æ‰¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ: \`npm run ai-context -- start --phase=poc\`
- ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®æ–‡è„ˆè¨˜éŒ²: \`npm run ai-context -- complete --phase=poc\`

**é‡è¦ãƒã‚¤ãƒ³ãƒˆä¾‹:**
- å®Ÿè£…ã®å®¹æ˜“ã•
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£`
            });
  implementation-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'implementation'
    runs-on: ubuntu-latest
    steps:
      - name: å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš™ï¸ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

PoCã®çµæœã¨è¨­è¨ˆã«åŸºã¥ãã€æœ¬ç•ªå“è³ªã®ã‚³ãƒ¼ãƒ‰ã‚’é–‹ç™ºã—ã¾ã™ã€‚GitHub Copilotã‚„Cursorãªã©ã‚’æ´»ç”¨ã—ã¾ã—ã‚‡ã†ã€‚

**è©³ç´°ã‚¬ã‚¤ãƒ‰:**
- [å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã®é€²ã‚æ–¹](../../docs/WORKFLOW_GUIDE.md#phase-3-å®Ÿè£…)

**é–¢é€£ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹:**
- å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®æ–‡è„ˆç¶™æ‰¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ: \`npm run ai-context -- start --phase=implementation\`
- ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®æ–‡è„ˆè¨˜éŒ²: \`npm run ai-context -- complete --phase=implementation\`

**ä¸»ãªä½œæ¥­:**
- ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¨™æº–ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®éµå®ˆ
- å˜ä½“ãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè£…ã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºä¿`
            });
  review-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'review' # é€šå¸¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯PRã«å¯¾ã—ã¦è¡Œã‚ã‚Œã‚‹ãŒã€Issueã«ãƒ©ãƒ™ãƒ«ãŒä»˜ãã‚±ãƒ¼ã‚¹ã‚‚è€ƒæ…®
    runs-on: ubuntu-latest
    steps:
      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚§ãƒ¼ã‚º

å®Ÿè£…ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®å“è³ªã€è¨­è¨ˆã®å¦¥å½“æ€§ã€è¦ä»¶å……è¶³åº¦ã‚’ç¢ºèªã—ã¾ã™ã€‚GitHub Copilot Agentã‚‚æ´»ç”¨ã—ã¾ã—ã‚‡ã†ã€‚

**è©³ç´°ã‚¬ã‚¤ãƒ‰:**
- [ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã®é€²ã‚æ–¹](../../docs/WORKFLOW_GUIDE.md#phase-4-ãƒ¬ãƒ“ãƒ¥ãƒ¼)

**é–¢é€£ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹:**
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®æ–‡è„ˆç¶™æ‰¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ: \`npm run ai-context -- start --phase=review\`
- ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®æ–‡è„ˆè¨˜éŒ²: \`npm run ai-context -- complete --phase=review\`

**ä¸»ãªä½œæ¥­:**
- Pull Requestä½œæˆã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼
- AIãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã¨äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿæ–½`
            });
  testing-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'testing'
    runs-on: ubuntu-latest
    steps:
      - name: ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚ºã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ§ª ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚§ãƒ¼ã‚º

ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å‹•ä½œã‚’æ¤œè¨¼ã—ã€æœ¬ç•ªç’°å¢ƒã¸ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã™ã€‚AIã‚’æ´»ç”¨ã—ãŸãƒ†ã‚¹ãƒˆã‚‚æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚

**è©³ç´°ã‚¬ã‚¤ãƒ‰:**
- [ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚§ãƒ¼ã‚ºã®é€²ã‚æ–¹](../../docs/WORKFLOW_GUIDE.md#phase-5-ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤)

**é–¢é€£ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹:**
- ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®æ–‡è„ˆç¶™æ‰¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ: \`npm run ai-context -- start --phase=testing\`
- ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®æ–‡è„ˆè¨˜éŒ²: \`npm run ai-context -- complete --phase=testing\`
- æ–‡è„ˆå“è³ªãƒã‚§ãƒƒã‚¯: \`npm run quality-check -- --phase=testing\`

**ä¸»ãªä½œæ¥­:**
- E2Eãƒ†ã‚¹ãƒˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã€å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆã®å®Ÿæ–½
- ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã«å¾“ã£ãŸãƒªãƒªãƒ¼ã‚¹ä½œæ¥­`
            });
  pr-automation:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Copilot Agentè‡ªå‹•è¿½åŠ ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–é€šçŸ¥
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: prNumber,
                reviewers: ['github-copilot'] // Your Copilot Agent's username if different
              });
              console.log('Successfully requested review from github-copilot.');
            } catch (error) {
              console.error('Failed to request review from github-copilot:', error);
              // Add a comment to the PR if reviewer assignment fails, e.g. if github-copilot is not a collaborator
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: 'Failed to automatically assign @github-copilot as a reviewer. Please assign manually.\nAIãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹: æ¨™æº–æº–æ‹ ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚«ãƒãƒ¬ãƒƒã‚¸'
              });
              return; // Exit if reviewer assignment failed
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: '@github-copilot ã•ã‚“ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚\n\n**AIãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:**\n- ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¨™æº–ã¸ã®æº–æ‹ \n- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ½œåœ¨çš„ãªè„†å¼±æ€§\n- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«é–¢ã™ã‚‹æ‡¸å¿µäº‹é …\n- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å¦¥å½“æ€§'
            });
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Or your preferred LTS version
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run linters
        run: npm run lint # Assuming you have an "lint" script in package.json
      - name: Run tests
        run: npm run test # Assuming you have a "test" script in package.json

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python # Adjust based on your project's languages
          # queries: +security-extended, # Optional: to run more queries
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  human-review-reminder:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'human-review-required'
    steps:
      - name: äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âš ï¸ äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™\n\nã“ã®Issueã«ã¯ `human-review-required` ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚\n\n**ç¢ºèªäº‹é …:**\n- [ ] ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å¦¥å½“æ€§\n- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã®è¦³ç‚¹\n- [ ] å€«ç†çš„é…æ…®äº‹é …\n- [ ] (ãã®ä»–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ç¢ºèªäº‹é …)\n\næ‹…å½“è€…ã¯ä¸Šè¨˜ã‚’ç¢ºèªã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã§çµæœã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚'
            });
