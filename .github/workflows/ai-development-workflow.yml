name: AI Development Workflow

on:
  issues:
    types: [opened, edited, labeled]
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  phase-detection:
    runs-on: ubuntu-latest
    outputs:
      phase: ${{ steps.detect.outputs.phase }}
    steps:
    - name: Detect Development Phase
      id: detect
      uses: actions/github-script@v6
      with:
        script: |
          const labels = context.payload.issue?.labels?.map(l => l.name) || 
                        context.payload.pull_request?.labels?.map(l => l.name) || [];
          
          if (labels.includes('requirements')) {
            core.setOutput('phase', 'requirements');
          } else if (labels.includes('poc')) {
            core.setOutput('phase', 'poc');
          } else if (labels.includes('implementation')) {
            core.setOutput('phase', 'implementation');
          } else if (context.eventName === 'pull_request') {
            core.setOutput('phase', 'review');
          }

  requirements-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'requirements'
    runs-on: ubuntu-latest
    steps:
    - name: Requirements Phase Notification
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `## ğŸ¯ è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚ºãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ
          
          ### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. **AIè­°è«–**: Claude/Gemini/ChatGPTã§è¦ä»¶ã‚’è©³ç´°åŒ–
          2. **å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [PROJECT_CONTEXT.md](./docs/PROJECT_CONTEXT.md)
          3. **è­°è«–ãƒ­ã‚°**: AIè­°è«–ã®é‡è¦éƒ¨åˆ†ã‚’ã“ã®Issueã«è¨˜éŒ²
          4. **äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼**: è­°è«–å®Œäº†å¾Œã€æ‰¿èªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç¢ºèª
          
          ### ğŸ¤– æ¨å¥¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          \`\`\`
          ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å‚è€ƒã«ã€è¦ä»¶å®šç¾©ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
          [PROJECT_CONTEXT.mdã®å†…å®¹ã‚’å‚ç…§]
          
          æ¤œè¨ã—ãŸã„æ©Ÿèƒ½: [å…·ä½“çš„ãªæ©Ÿèƒ½è¦æ±‚]
          åˆ¶ç´„æ¡ä»¶: [æŠ€è¡“çš„ãƒ»ãƒ“ã‚¸ãƒã‚¹çš„åˆ¶ç´„]
          \`\`\`
          
          ### âš ï¸ é‡è¦
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’å¿…ãšæ¤œè¨ã—ã¦ãã ã•ã„
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã‚’æ˜ç¢ºåŒ–ã—ã¦ãã ã•ã„
          - æ‰¿èªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå®Œäº†å¾Œã€æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã—ã¦ãã ã•ã„`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  poc-phase:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'poc'
    runs-on: ubuntu-latest
    steps:
    - name: PoC Phase Notification
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `## ğŸ§ª PoCãƒ•ã‚§ãƒ¼ã‚ºãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ
          
          ### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. **Windsurfé–‹ç™º**: è‡ªå‹•é‹è»¢ãƒ¢ãƒ¼ãƒ‰ã§è¿…é€Ÿã«ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ä½œæˆ
          2. **å‚ç…§æƒ…å ±**: [AI_INTERACTION_LOG.md](./docs/AI_INTERACTION_LOG.md)ã‹ã‚‰å‰ãƒ•ã‚§ãƒ¼ã‚ºã®æ–‡è„ˆã‚’ç¢ºèª
          3. **æ¤œè¨¼å®Ÿè¡Œ**: åŸºæœ¬æ©Ÿèƒ½ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»çµ±åˆå¯èƒ½æ€§ã‚’ç¢ºèª
          4. **çµæœè¨˜éŒ²**: ç™ºè¦‹äº‹é …ã¨æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’Issueã«è¨˜éŒ²
          
          ### ğŸ¤– Windsurfå‘ã‘ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          \`\`\`
          è¦ä»¶å®šç¾©çµæœã«åŸºã¥ã„ã¦PoCã‚’é–‹ç™ºã—ã¦ãã ã•ã„ï¼š
          - å®Ÿè£…å ´æ‰€: /poc/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          - å‚ç…§åŸºæº–: docs/CODING_STANDARDS.md
          - å„ªå…ˆåº¦: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ > æ©Ÿèƒ½ > ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
          \`\`\`
          
          ### âš ï¸ é‡è¦
          - å‹•ä½œã™ã‚‹ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ¬ãƒ™ãƒ«ã§ååˆ†ã§ã™
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã‚‚å®Ÿæ–½ã—ã¦ãã ã•ã„  
          - æœ¬å®Ÿè£…ã§ã®èª²é¡Œãƒ»æ¨å¥¨äº‹é …ã‚’å¿…ãšè¨˜éŒ²ã—ã¦ãã ã•ã„`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  pr-automation:
    needs: phase-detection
    if: needs.phase-detection.outputs.phase == 'review'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Add Copilot as Reviewer
      uses: actions/github-script@v6
      with:
        script: |
          // GitHub Copilot Agentã‚’ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã«è¿½åŠ 
          try {
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              team_reviewers: ['copilot']
            });
          } catch (error) {
            console.log('Copilot reviewer addition failed:', error.message);
          }
          
    - name: AI Review Context
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `## ğŸ¤– AI Code Review Context
          
          ### ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–
          - **ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¨™æº–**: [CODING_STANDARDS.md](./docs/CODING_STANDARDS.md)
          - **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: [ARCHITECTURE.md](./docs/ARCHITECTURE.md) 
          - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**: å…¥åŠ›å€¤æ¤œè¨¼ã€èªè¨¼ãƒ»èªå¯ã€ãƒ­ã‚°å‡ºåŠ›åŸºæº–
          
          ### ğŸ” é‡ç‚¹ç¢ºèªé …ç›®
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®å®Ÿè£…
          - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è€ƒæ…®
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®é©åˆ‡æ€§
          - [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å¦¥å½“æ€§
          - [ ] ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¨™æº–æº–æ‹ 
          
          @github-copilot ä¸Šè¨˜åŸºæº–ã«å¾“ã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: javascript, python
        
    - name: Autobuild
      uses: github/codeql-action/autobuild@v2
      
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  human-review-reminder:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'human-review-required')
    steps:
    - name: Human Review Reminder
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `## ğŸš¨ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™
          
          ã“ã®Issueã¯äººé–“ã«ã‚ˆã‚‹é‡è¦ãªåˆ¤æ–­ãŒå¿…è¦ã§ã™ï¼š
          
          ### âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [ ] **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ç¢ºèª**: ROIã¨å„ªå…ˆåº¦ã¯é©åˆ‡ã‹
          - [ ] **æŠ€è¡“çš„å¦¥å½“æ€§**: ææ¡ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯å®Ÿç¾å¯èƒ½ã‹
          - [ ] **ãƒªã‚¹ã‚¯è©•ä¾¡**: ç‰¹å®šã•ã‚ŒãŸãƒªã‚¹ã‚¯ã¯è¨±å®¹ç¯„å›²ã‹
          - [ ] **ãƒªã‚½ãƒ¼ã‚¹è¨ˆç”»**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»äººå“¡ã¯ç¾å®Ÿçš„ã‹
          - [ ] **æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡Œæ‰¿èª**: æ¬¡æ®µéšã¸ã®é€²è¡Œã‚’æ‰¿èªã™ã‚‹ã‹
          
          ### â° ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š
          - \`approved\`: æ‰¿èªãƒ»æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡ŒOK
          - \`needs-revision\`: ä¿®æ­£ãŒå¿…è¦
          - \`rejected\`: å´ä¸‹ãƒ»ä»£æ›¿æ¡ˆæ¤œè¨`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
